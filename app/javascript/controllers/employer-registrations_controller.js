import { Controller } from "stimulus"

export default class extends Controller {

  static targets = [ "companyType", "evidence", "successor", "previousOrganization", "contributionStep", "message" ]
  wasPrevious;
  stepIndex;
  contributorText;
  initialize() {
        var form = $(".validation-wizard").show();

        $(".validation-wizard").steps({
            headerTag: "h6",
            bodyTag: "section",
            transitionEffect: "fade",
            titleTemplate: '<span class="step">#index#</span> #title#',
            labels: {
                finish: "Submit"
            },
            onStepChanging: function (event, currentIndex, newIndex) {
                return currentIndex > newIndex || !(3 === newIndex && Number($("#age-2").val()) < 18) && (currentIndex < newIndex && (form.find(".body:eq(" + newIndex + ") label.error").remove(), form.find(".body:eq(" + newIndex + ") .error").removeClass("error")), form.validate().settings.ignore = ":disabled,:hidden", form.valid())
            },
            onFinishing: function (event, currentIndex) {
                return form.validate().settings.ignore = ":disabled", form.valid()
            },
            onFinished: function (event, currentIndex) {
                swal("Form Submitted!", "Your employer registration has been received check email for next steps.");
            }
        }), $(".validation-wizard").validate({
            ignore: "input[type=hidden]",
            errorClass: "text-danger",
            successClass: "text-success",
            highlight: function (element, errorClass) {
                $(element).removeClass(errorClass)
            },
            unhighlight: function (element, errorClass) {
                $(element).removeClass(errorClass)
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element)
            },
            rules: {
                email: {
                    email: !0
                }
            }
        })
        // Adds click event to buttons generated by jquery steps wizard
        let ele = document.querySelectorAll('[role="menuitem"]');
        for (var i = 0; i < ele.length; i++) {
          ele[i].setAttribute('data-action', 'employer-registrations#showText');
        }

  }

  evidenceNeeded() {
    if (this.companyTypeTarget.value == "reimbursable") {
      this.evidenceTarget.classList.remove('d-none')
      this.successorTarget.classList.remove('d-none')
    } else {
      this.evidenceTarget.classList.add('d-none')
      this.successorTarget.classList.add('d-none')
    }
  }

  showText() {
    let comType = this.companyTypeTarget.value;

    this.previousOrganizationTargets.map(input => {
      if (input.checked) {
        this.wasPrevious = input.value;
      }
    })

    let prevOrg = this.wasPrevious;

    if (comType && comType === 'contributor') this.contributorText = 'Thank you for registering.  As a new employer in the district, your tax liablity rate for the first year is set at 2.7%. This rate will be adjusted for future tax years based on your experience, including turnover and claims experience.'
    if (comType && prevOrg && comType === 'reimbursable' && prevOrg === 'no') this.contributorText = 'Thank you for registering. Verification of your reimbursable status is underway. DOES staff will contact you if any additional information is requested. Once verified, your tax liability rate as a reimbursable employer will be set at 0%.'
    if (comType && prevOrg && comType === 'reimbursable' && prevOrg === 'yes') this.contributorText = 'Verification of this organizations relationship with the provided predecessor is underway. DOES staff will contact you if any additional information is required. Once verified, your tax liability rate will be set at the most recent rate of the predecessor organization.'
    this.messageTarget.innerText = this.contributorText;
  }
}
